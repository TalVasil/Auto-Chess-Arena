# RECONNECTION WORK PLAN - BEGINNER FRIENDLY

Complete guide for implementing reconnection system in Auto Chess Arena game.

---

## PHASE 1: Save Game Session Data (4 Steps)

### Step 1: Save session data when connecting to game
**File:** `client/src/network/GameClient.ts`
**Line:** Around 62
**Action:** Add localStorage save after connection succeeds

### Step 2: Create function to read saved session
**File:** `client/src/network/GameClient.ts`
**Line:** Around 145 (after send() function)
**Action:** Add getStoredSession() function

### Step 3: Create function to erase saved session
**File:** `client/src/network/GameClient.ts`
**Line:** After getStoredSession() function
**Action:** Add clearStoredSession() function

### Step 4: Verify session is stored in game state
**File:** `client/src/store/gameStore.ts`
**Line:** Around 181-187
**Action:** Verify existing code (already correct)

---

## PHASE 2: Try to Reconnect on Page Load (3 Steps)

### Step 5: Add reconnection logic to connect function
**File:** `client/src/network/GameClient.ts`
**Line:** 37 (connect function)
**Action:** Add tryReconnect parameter and reconnection logic

### Step 6: Update game store to attempt reconnection first
**File:** `client/src/store/gameStore.ts`
**Line:** 178 (connect function)
**Action:** Check for saved session and pass reconnect flag

### Step 7: Read GameLobby to understand connection flow
**File:** `client/src/components/GameLobby.tsx`
**Action:** Read file to understand where connection happens

---

## PHASE 3: Handle Disconnections (4 Steps)

### Step 8: Detect when disconnect was accidental
**File:** `client/src/network/GameClient.ts`
**Line:** 130 (onLeave handler)
**Action:** Check disconnect code, keep session if accidental

### Step 9: Add automatic reconnection on disconnect
**File:** `client/src/network/GameClient.ts`
**Line:** Same onLeave handler
**Action:** Add setTimeout auto-reconnect logic

### Step 10: Add exponential backoff (retry with delays)
**File:** `client/src/network/GameClient.ts`
**Line:** Top of class + new attemptReconnect() function
**Action:** Add retry counter and exponential delay logic

### Step 11: Reset retry counter on successful connection
**File:** `client/src/network/GameClient.ts`
**Line:** End of connect() function
**Action:** Set reconnectAttempts = 0 on success

---

## PHASE 4: Clean Up Session Data (3 Steps)

### Step 12: Clear session on intentional disconnect
**File:** `client/src/network/GameClient.ts`
**Line:** 71 (disconnect function)
**Action:** Add clearStoredSession() call

### Step 13: Clear session on logout
**File:** `client/src/store/gameStore.ts`
**Line:** 118 (logout function)
**Action:** Already done via disconnect() call

### Step 14: Clear session when joining new game
**File:** `client/src/network/GameClient.ts`
**Action:** Already done (setItem overwrites old data)

---

## PHASE 5: UI Feedback (4 Steps)

### Step 15: Add reconnecting status to GameClient
**File:** `client/src/network/GameClient.ts`
**Line:** Top of class
**Action:** Add isReconnecting property and getter

### Step 16: Add reconnecting status to gameStore
**File:** `client/src/store/gameStore.ts`
**Line:** Interface (42) and initial state (84)
**Action:** Add isReconnecting: boolean field

### Step 17: Show reconnecting message in UI
**File:** `client/src/components/GameLobby.tsx`
**Action:** Add "Reconnecting..." message with spinner

### Step 18: Show reconnection failure message
**File:** `client/src/components/GameLobby.tsx`
**Action:** Show error after 5 failed attempts

---

## PHASE 6: Testing (7 Steps)

### Step 19: Test browser refresh during WAITING phase
**Action:** Join lobby, press F5, verify reconnection

### Step 20: Test browser refresh during PREPARATION phase
**Action:** Buy characters, refresh, verify state preserved

### Step 21: Test browser close and reopen
**Action:** Close tab, wait, reopen, verify reconnection

### Step 22: Test network disconnect
**Action:** Disable WiFi, re-enable, verify auto-reconnect

### Step 23: Test grace period expiration (6 minutes)
**Action:** Wait 7 minutes, verify can't reconnect

### Step 24: Test intentional disconnect
**Action:** Logout, login, verify joins NEW game

### Step 25: Test multiple rapid reconnections
**Action:** Refresh 3 times quickly, verify no duplication

---

## KEY CONCEPTS

### localStorage
- Browser's permanent notebook
- Data survives page refresh and browser close
- `setItem(key, value)` = Write
- `getItem(key)` = Read
- `removeItem(key)` = Erase

### sessionId
- Your unique player ID in the game
- Like a seat number: "You are Player 3"
- Generated by Colyseus server when you join

### roomId
- Which game room you're in
- Like room number: "You're in Room ABC123"
- Identifies the specific game session

### Disconnect Codes
- `1000` = Normal close (user clicked logout)
- `1001` = Going away (browser closed)
- `1006` = Abnormal close (network error)
- Other = Various disconnect reasons

### Exponential Backoff
- Retry with increasing delays
- Attempt 1: 1 second
- Attempt 2: 2 seconds
- Attempt 3: 4 seconds
- Attempt 4: 8 seconds
- Attempt 5: 16 seconds
- Prevents server spam

---

## CURRENT STATUS

✅ = Completed
⏸️ = In Progress
⏳ = Pending

### Phase 1: ⏳ Starting Step 1
### Phase 2: ⏳ Not Started
### Phase 3: ⏳ Not Started
### Phase 4: ⏳ Not Started
### Phase 5: ⏳ Not Started
### Phase 6: ⏳ Not Started
